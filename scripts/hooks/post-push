#!/bin/bash
# Auto-generate PR after pushing a branch

# Get the branch that was just pushed
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE="${1:-origin}"

# Don't create PR for main/master branches
if [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]]; then
  exit 0
fi

# Check if gh CLI is available
if ! command -v gh &> /dev/null; then
  echo "[Auto-PR] gh CLI not found. Install it to enable auto PR creation."
  exit 0
fi

# Check if PR already exists for this branch
EXISTING_PR=$(gh pr list --head "$CURRENT_BRANCH" --json number --jq '.[0].number' 2>/dev/null)

if [[ -n "$EXISTING_PR" ]]; then
  echo "[Auto-PR] PR #$EXISTING_PR already exists for branch $CURRENT_BRANCH"
  exit 0
fi

# Generate PR title from branch name
# Example: feature/priority-requests -> feat: priority requests
PR_TITLE=$(echo "$CURRENT_BRANCH" | sed 's|^feature/|feat: |' | sed 's|^bugfix/|fix: |' | sed 's|^fix/|fix: |' | sed 's|-| |g')

# Generate PR body from recent commits
PR_BODY=$(cat <<EOF
## Summary

$(git log origin/main..HEAD --pretty=format:"- %s" | head -10)

## Changes

$(git diff origin/main..HEAD --stat)

## Test Plan

- [ ] Manual testing completed
- [ ] Unit tests pass
- [ ] Integration tests pass

---

ðŸ¤– Auto-generated by post-push hook
EOF
)

# Create PR
echo "[Auto-PR] Creating pull request for $CURRENT_BRANCH..."
gh pr create \
  --title "$PR_TITLE" \
  --body "$PR_BODY" \
  --base main \
  --head "$CURRENT_BRANCH"

if [[ $? -eq 0 ]]; then
  echo "[Auto-PR] âœ“ Pull request created successfully!"
  gh pr view --web
else
  echo "[Auto-PR] âœ— Failed to create pull request"
fi

exit 0
